<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Page</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        #gameCanvas {
            width: 100%;
            height: 200px;
            border: 2px solid #555;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: left;
            word-wrap: break-word;
            white-space: pre-wrap;
            background-color: #1e1e1e;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .correct {
            color: #4caf50;
        }

        .incorrect {
            color: #f44336;
        }
    </style>
</head>

<body>
    <div id="gamePage" class="page active">
        <h1>Game Page</h1>
        <p>Level: <span id="level">1</span></p>
        <p>Score: <span id="score">0</span></p>
        <div id="gameCanvas"></div>
        <p id="timer">Time left: 30 seconds</p>
        <button onclick="navigateToMenu()">Back to Menu</button>
    </div>

    <script>
        let timerInterval;
        let timeLeft = 30;
        let currentSentence = "";
        let score = 0;
        let level = 1;
        let userInput = "";
        let inputHistory = [];

        document.addEventListener('DOMContentLoaded', () => {
            startGame();
        });

        function navigateToMenu() {
            window.location.href = 'menu.html';
        }

        function startGame() {
            // Update level and score
            document.getElementById('level').textContent = level;
            document.getElementById('score').textContent = score;

            // Fetch a random sentence from the server
            fetch('/get-sentence')
                .then(response => response.json())
                .then(data => {
                    currentSentence = data.sentence.trim();
                    userInput = "";
                    updateCanvas();

                    timeLeft = 30 - (level - 1) * 2; // Decrease time as level increases
                    document.getElementById('timer').textContent = `Time left: ${timeLeft} seconds`;

                    // Start the timer
                    timerInterval = setInterval(() => {
                        timeLeft--;
                        document.getElementById('timer').textContent = `Time left: ${timeLeft} seconds`;

                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            checkResult();
                        }
                    }, 1000);
                })
                .catch(error => console.error('Error fetching sentence:', error));
        }

        function updateCanvas() {
            const gameCanvas = document.getElementById('gameCanvas');
            let displayText = "";
            for (let i = 0; i < currentSentence.length; i++) {
                if (i < userInput.length) {
                    if (userInput[i] === currentSentence[i]) {
                        displayText += `<span class="correct">${currentSentence[i]}</span>`;
                    } else {
                        displayText += `<span class="incorrect">${currentSentence[i]}</span>`;
                    }
                } else {
                    displayText += `<span>${currentSentence[i]}</span>`;
                }
            }
            gameCanvas.innerHTML = displayText;
        }

        document.addEventListener('keydown', (event) => {
            if (document.getElementById('gamePage').classList.contains('active')) {
                if (event.key.length === 1 && !event.ctrlKey && !event.metaKey) {
                    userInput += event.key;
                } else if (event.key === 'Backspace') {
                    userInput = userInput.slice(0, -1);
                }
                updateCanvas();
                recordInput(event.key);
            }
        });

        function recordInput(key) {
            const timestamp = new Date().toISOString();
            inputHistory.push({ input: key, timestamp: timestamp });
        }


        function checkResult() {
            if (userInput === currentSentence) {
                score += 10 * level;
                level++;
            }

            // Save the final score, level, and input history
            const gameData = {
                score: score,
                level: level,
                inputHistory: inputHistory,
                currentSentence: currentSentence,
                userInput: userInput
            };

            // Save data to the backend for statistics generation
            fetch('/save-game-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(gameData),
            })
                .then(() => {
                    localStorage.setItem('score', score);
                    localStorage.setItem('level', level);
                    window.location.href = 'result.html';
                })
                .catch(error => console.error('Error saving game data:', error));
        }
    </script>

</body>

</html>